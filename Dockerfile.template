FROM balenalib/%%BALENA_MACHINE_NAME%%-debian-golang:1.17-bullseye-build as build

WORKDIR /go/src/c4v/monitor

COPY pkg/ pkg/
COPY cmd/ cmd/
COPY go.mod go.mod
COPY go.sum go.sum
COPY Makefile Makefile
COPY config.yaml.sample config.yaml

RUN apt-get update && apt-get install -y kmod

RUN make

FROM balenalib/%%BALENA_MACHINE_NAME%%-debian:bullseye-run

WORKDIR /go/src/c4v/monitor

COPY --from=build /go/src/c4v/monitor/bin/poweroutage .

RUN pwd
RUN ls

CMD modprobe i2c-dev && ./poweroutage